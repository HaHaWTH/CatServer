--- a/net/minecraft/world/raid/RaidManager.java
+++ b/net/minecraft/world/raid/RaidManager.java
@@ -24,9 +_,10 @@
 import net.minecraft.world.GameRules;
 import net.minecraft.world.server.ServerWorld;
 import net.minecraft.world.storage.WorldSavedData;
+import org.bukkit.craftbukkit.v1_16_R3.event.CraftEventFactory;
 
 public class RaidManager extends WorldSavedData {
-   private final Map<Integer, Raid> raidMap = Maps.newHashMap();
+   public final Map<Integer, Raid> raidMap = Maps.newHashMap();
    private final ServerWorld level;
    private int nextAvailableID;
    private int tick;
@@ -108,19 +_,32 @@
             Raid raid = this.getOrCreateRaid(p_215170_1_.getLevel(), blockpos1);
             boolean flag = false;
             if (!raid.isStarted()) {
-               if (!this.raidMap.containsKey(raid.getId())) {
-                  this.raidMap.put(raid.getId(), raid);
+               /* CraftBukkit - moved down
+               if (!this.byId.containsKey(raid.getId())) {
+                  this.byId.put(raid.getId(), raid);
                }
+               */
 
                flag = true;
-            } else if (raid.getBadOmenLevel() < raid.getMaxBadOmenLevel()) {
+               // CraftBukkit start - fixed a bug with raid: players could add up Bad Omen level even when the raid had finished
+            } else if (raid.isInProgress() && raid.getBadOmenLevel() < raid.getMaxBadOmenLevel()) {
                flag = true;
+               // CraftBukkit end
             } else {
                p_215170_1_.removeEffect(Effects.BAD_OMEN);
                p_215170_1_.connection.send(new SEntityStatusPacket(p_215170_1_, (byte)43));
             }
 
             if (flag) {
+               // CraftBukkit start
+               if (!CraftEventFactory.callRaidTriggerEvent(raid, p_215170_1_)) {
+                  p_215170_1_.removeEffect(Effects.BAD_OMEN);
+                  return null;
+               }
+               if (!this.raidMap.containsKey(raid.getId())) {
+                  this.raidMap.put(raid.getId(), raid);
+               }
+               // CraftBukkit end
                raid.absorbBadOmen(p_215170_1_);
                p_215170_1_.connection.send(new SEntityStatusPacket(p_215170_1_, (byte)43));
                if (!raid.hasFirstWaveSpawned()) {
