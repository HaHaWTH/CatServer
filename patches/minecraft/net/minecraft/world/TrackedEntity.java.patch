--- a/net/minecraft/world/TrackedEntity.java
+++ b/net/minecraft/world/TrackedEntity.java
@@ -4,6 +_,7 @@
 import com.mojang.datafixers.util.Pair;
 import java.util.Collection;
 import java.util.Collections;
+import java.util.HashSet;
 import java.util.List;
 import java.util.Set;
 import java.util.function.Consumer;
@@ -37,6 +_,8 @@
 import net.minecraft.world.storage.MapData;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
+import org.bukkit.entity.Player;
+import org.bukkit.event.player.PlayerVelocityEvent;
 
 public class TrackedEntity {
    private static final Logger LOGGER = LogManager.getLogger();
@@ -58,7 +_,15 @@
    private boolean wasRiding;
    private boolean wasOnGround;
 
+   // CraftBukkit Start
+   private Set<ServerPlayerEntity> trackedPlayers;
+
+   public void setTrackedPlayers(Set<ServerPlayerEntity> trackedPlayers) {
+      this.trackedPlayers = trackedPlayers;
+   }
+
    public TrackedEntity(ServerWorld p_i50704_1_, Entity p_i50704_2_, int p_i50704_3_, boolean p_i50704_4_, Consumer<IPacket<?>> p_i50704_5_) {
+      this.trackedPlayers = new HashSet<>();
       this.level = p_i50704_1_;
       this.broadcast = p_i50704_5_;
       this.entity = p_i50704_2_;
@@ -75,24 +_,25 @@
       List<Entity> list = this.entity.getPassengers();
       if (!list.equals(this.lastPassengers)) {
          this.lastPassengers = list;
-         this.broadcast.accept(new SSetPassengersPacket(this.entity));
+         this.broadcastAndSend(new SSetPassengersPacket(this.entity)); // CraftBukkit
       }
 
-      if (this.entity instanceof ItemFrameEntity && this.tickCount % 10 == 0) {
+      // PAIL : rename
+      if (this.entity instanceof ItemFrameEntity /*&& this.updateCounter % 10 == 0*/) { // CraftBukkit - Moved below, should always enter this block
          ItemFrameEntity itemframeentity = (ItemFrameEntity)this.entity;
          ItemStack itemstack = itemframeentity.getItem();
-         if (itemstack.getItem() instanceof FilledMapItem) {
+         if (this.tickCount % 10 == 0 && itemstack.getItem() instanceof FilledMapItem) { // CraftBukkit - Moved this.tickCounter % 10 logic here so item frames do not enter the other blocks
             MapData mapdata = FilledMapItem.getOrCreateSavedData(itemstack, this.level);
-
-            for(ServerPlayerEntity serverplayerentity : this.level.players()) {
-               mapdata.tickCarriedBy(serverplayerentity, itemstack);
-               IPacket<?> ipacket = ((FilledMapItem)itemstack.getItem()).getUpdatePacket(itemstack, this.level, serverplayerentity);
-               if (ipacket != null) {
-                  serverplayerentity.connection.send(ipacket);
+            if (mapdata != null) {
+               for(ServerPlayerEntity serverplayerentity : this.trackedPlayers) {  // CraftBukkit
+                  mapdata.tickCarriedBy(serverplayerentity, itemstack);
+                  IPacket<?> ipacket = ((FilledMapItem) itemstack.getItem()).getUpdatePacket(itemstack, this.level, serverplayerentity);
+                  if (ipacket != null) {
+                     serverplayerentity.connection.send(ipacket);
+                  }
                }
             }
          }
-
          this.sendDirtyEntityData();
       }
 
@@ -119,6 +_,18 @@
             IPacket<?> ipacket1 = null;
             boolean flag4 = flag3 || this.tickCount % 60 == 0;
             boolean flag = Math.abs(l - this.yRotp) >= 1 || Math.abs(k1 - this.xRotp) >= 1;
+
+            // CraftBukkit start - Code moved from below
+            if (flag4) {
+               this.updateSentPos();
+            }
+
+            if (flag) {
+               this.yRotp = l;
+               this.xRotp = k1;
+            }
+            // CraftBukkit end
+
             if (this.tickCount > 0 || this.entity instanceof AbstractArrowEntity) {
                long i = SEntityPacket.entityToPacket(vector3d.x);
                long j = SEntityPacket.entityToPacket(vector3d.y);
@@ -155,14 +_,16 @@
             }
 
             this.sendDirtyEntityData();
+             /* CraftBukkit start - Code moved up
             if (flag4) {
-               this.updateSentPos();
+               this.updateEncodedPosition();
             }
 
             if (flag) {
-               this.yRotp = l;
-               this.xRotp = k1;
+               this.encodedRotationYaw = l;
+               this.encodedRotationPitch = k1;
             }
+            // CraftBukkit end */
 
             this.wasRiding = false;
          }
@@ -178,7 +_,23 @@
 
       ++this.tickCount;
       if (this.entity.hurtMarked) {
-         this.broadcastAndSend(new SEntityVelocityPacket(this.entity));
+         // CraftBukkit start - Create PlayerVelocity event
+         boolean cancelled = false;
+         if (this.entity instanceof ServerPlayerEntity) {
+            Player player = (Player) this.entity.getBukkitEntity();
+            org.bukkit.util.Vector velocity = player.getVelocity();
+            PlayerVelocityEvent event = new PlayerVelocityEvent(player, velocity.clone());
+            this.entity.level.getCBServer().getPluginManager().callEvent(event);
+            if (event.isCancelled()) {
+               cancelled = true;
+            } else if (!velocity.equals(event.getVelocity())) {
+               player.setVelocity(event.getVelocity());
+            }
+         }
+         if (!cancelled) {
+            this.broadcastAndSend(new SEntityVelocityPacket(this.entity));
+         }
+         // CraftBukkit end
          this.entity.hurtMarked = false;
       }
 
@@ -187,17 +_,31 @@
    public void removePairing(ServerPlayerEntity p_219454_1_) {
       this.entity.stopSeenByPlayer(p_219454_1_);
       p_219454_1_.sendRemoveEntity(this.entity);
+      net.minecraftforge.event.ForgeEventFactory.onStopEntityTracking(this.entity, p_219454_1_);
    }
 
    public void addPairing(ServerPlayerEntity p_219455_1_) {
+      sendSpawnPacketsPlayer = p_219455_1_;
       this.sendPairingData(p_219455_1_.connection::send);
       this.entity.startSeenByPlayer(p_219455_1_);
       p_219455_1_.cancelRemoveEntity(this.entity);
-   }
-
+      net.minecraftforge.event.ForgeEventFactory.onStartEntityTracking(this.entity, p_219455_1_);
+   }
+
+   public void a(Consumer<IPacket<?>> packetConsumer, ServerPlayerEntity player) {
+      sendSpawnPacketsPlayer = player;
+      sendPairingData(packetConsumer);
+   }
+
+   ServerPlayerEntity sendSpawnPacketsPlayer;
    public void sendPairingData(Consumer<IPacket<?>> p_219452_1_) {
+      ServerPlayerEntity serverPlayerEntity = sendSpawnPacketsPlayer;
+      sendSpawnPacketsPlayer = null;
       if (this.entity.removed) {
-         LOGGER.warn("Fetching packet for removed entity " + this.entity);
+         // CraftBukkit start - Remove useless error spam, just return
+         //LOGGER.warn("Fetching packet for removed entity " + this.trackedEntity);
+         return;
+         // CraftBukkit end
       }
 
       IPacket<?> ipacket = this.entity.getAddEntityPacket();
@@ -210,6 +_,13 @@
       boolean flag = this.trackDelta;
       if (this.entity instanceof LivingEntity) {
          Collection<ModifiableAttributeInstance> collection = ((LivingEntity)this.entity).getAttributes().getSyncableAttributes();
+
+         // CraftBukkit start - If sending own attributes send scaled health instead of current maximum health
+         if (this.entity.getId() == serverPlayerEntity.getId()) {
+            ((ServerPlayerEntity) this.entity).getBukkitEntity().injectScaledMaxHealth(collection, false);
+         }
+         // CraftBukkit end
+
          if (!collection.isEmpty()) {
             p_219452_1_.accept(new SEntityPropertiesPacket(this.entity.getId(), collection));
          }
@@ -237,7 +_,13 @@
          if (!list.isEmpty()) {
             p_219452_1_.accept(new SEntityEquipmentPacket(this.entity.getId(), list));
          }
+         ((LivingEntity) this.entity).detectEquipmentUpdates(); // CraftBukkit - SPIGOT-3789: sync again immediately after sending
       }
+
+      // CraftBukkit start - Fix for nonsensical head yaw
+      this.yHeadRotp = MathHelper.floor(this.entity.getYHeadRot() * 256.0F / 360.0F);
+      p_219452_1_.accept(new SEntityHeadLookPacket(this.entity, (byte) yHeadRotp));
+      // CraftBukkit end
 
       if (this.entity instanceof LivingEntity) {
          LivingEntity livingentity = (LivingEntity)this.entity;
@@ -273,6 +_,11 @@
       if (this.entity instanceof LivingEntity) {
          Set<ModifiableAttributeInstance> set = ((LivingEntity)this.entity).getAttributes().getDirtyAttributes();
          if (!set.isEmpty()) {
+            // CraftBukkit start - Send scaled max health
+            if (this.entity instanceof ServerPlayerEntity) {
+               ((ServerPlayerEntity) this.entity).getBukkitEntity().injectScaledMaxHealth(set, false);
+            }
+            // CraftBukkit end
             this.broadcastAndSend(new SEntityPropertiesPacket(this.entity.getId(), set));
          }
 
