--- a/net/minecraft/entity/merchant/villager/VillagerEntity.java
+++ b/net/minecraft/entity/merchant/villager/VillagerEntity.java
@@ -72,7 +_,6 @@
 import net.minecraft.util.math.BlockPos;
 import net.minecraft.util.math.GlobalPos;
 import net.minecraft.util.math.MathHelper;
-import net.minecraft.util.registry.Registry;
 import net.minecraft.util.text.ITextComponent;
 import net.minecraft.util.text.TranslationTextComponent;
 import net.minecraft.village.GossipManager;
@@ -87,6 +_,13 @@
 import net.minecraft.world.server.ServerWorld;
 import net.minecraftforge.api.distmarker.Dist;
 import net.minecraftforge.api.distmarker.OnlyIn;
+import org.bukkit.Bukkit;
+import org.bukkit.craftbukkit.v1_16_R3.event.CraftEventFactory;
+import org.bukkit.entity.Villager;
+import org.bukkit.event.entity.CreatureSpawnEvent;
+import org.bukkit.event.entity.EntityPotionEffectEvent;
+import org.bukkit.event.entity.EntityTransformEvent;
+import org.bukkit.event.entity.VillagerReplenishTradeEvent;
 
 public class VillagerEntity extends AbstractVillagerEntity implements IReputationTracking, IVillagerDataHolder {
    private static final DataParameter<VillagerData> DATA_VILLAGER_DATA = EntityDataManager.defineId(VillagerEntity.class, DataSerializers.VILLAGER_DATA);
@@ -190,6 +_,17 @@
       return this.assignProfessionWhenSpawned;
    }
 
+   // Spigot Start
+   @Override
+   public void inactiveTick() {
+      // SPIGOT-3874, SPIGOT-3894, SPIGOT-3846, SPIGOT-5286 :(
+      if (level.spigotConfig.tickInactiveVillagers && this.isEffectiveAi()) {
+         this.customServerAiStep();
+      }
+      super.inactiveTick();
+   }
+   // Spigot End
+
    protected void customServerAiStep() {
       this.level.getProfiler().push("villagerBrain");
       this.getBrain().tick((ServerWorld)this.level, this);
@@ -206,7 +_,7 @@
                this.increaseProfessionLevelOnUpdate = false;
             }
 
-            this.addEffect(new EffectInstance(Effects.REGENERATION, 200, 0));
+            this.addEffect(new EffectInstance(Effects.REGENERATION, 200, 0), EntityPotionEffectEvent.Cause.VILLAGER_TRADE); // CraftBukkit
          }
       }
 
@@ -241,7 +_,7 @@
 
    public ActionResultType mobInteract(PlayerEntity p_230254_1_, Hand p_230254_2_) {
       ItemStack itemstack = p_230254_1_.getItemInHand(p_230254_2_);
-      if (itemstack.getItem() != Items.VILLAGER_SPAWN_EGG && this.isAlive() && !this.isTrading() && !this.isSleeping()) {
+      if (itemstack.getItem() != Items.VILLAGER_SPAWN_EGG && this.isAlive() && !this.isTrading() && !this.isSleeping() && !p_230254_1_.isSecondaryUseActive()) {
          if (this.isBaby()) {
             this.setUnhappy();
             return ActionResultType.sidedSuccess(this.level.isClientSide);
@@ -379,7 +_,14 @@
       int i = this.getPlayerReputation(p_213762_1_);
       if (i != 0) {
          for(MerchantOffer merchantoffer : this.getOffers()) {
-            merchantoffer.addToSpecialPriceDiff(-MathHelper.floor((float)i * merchantoffer.getPriceMultiplier()));
+            // CraftBukkit start
+            int bonus = -MathHelper.floor((float)i * merchantoffer.getPriceMultiplier());
+            VillagerReplenishTradeEvent event = new VillagerReplenishTradeEvent((Villager) this.getBukkitEntity(), merchantoffer.asBukkit(), bonus);
+            Bukkit.getPluginManager().callEvent(event);
+            if (!event.isCancelled()) {
+               merchantoffer.addToSpecialPriceDiff(event.getBonus());
+            }
+            // CraftBukkit end
          }
       }
 
@@ -523,7 +_,7 @@
    }
 
    public void die(DamageSource p_70645_1_) {
-      LOGGER.info("Villager {} died, message: '{}'", this, p_70645_1_.getLocalizedDeathMessage(this).getString());
+      if (org.spigotmc.SpigotConfig.logVillagerDeaths) LOGGER.info("Villager {} died, message: '{}'", this, p_70645_1_.getLocalizedDeathMessage(this).getString()); // Spigot
       Entity entity = p_70645_1_.getEntity();
       if (entity != null) {
          this.tellWitnessesThatIWasMurdered(entity);
@@ -634,7 +_,8 @@
    }
 
    protected ITextComponent getTypeName() {
-      return new TranslationTextComponent(this.getType().getDescriptionId() + '.' + Registry.VILLAGER_PROFESSION.getKey(this.getVillagerData().getProfession()).getPath());
+      net.minecraft.util.ResourceLocation profName = this.getVillagerData().getProfession().getRegistryName();
+      return new TranslationTextComponent(this.getType().getDescriptionId() + '.' + (!"minecraft".equals(profName.getNamespace()) ? profName.getNamespace() + '.' : "") + profName.getPath());
    }
 
    @OnlyIn(Dist.CLIENT)
@@ -687,7 +_,7 @@
    }
 
    public void thunderHit(ServerWorld p_241841_1_, LightningBoltEntity p_241841_2_) {
-      if (p_241841_1_.getDifficulty() != Difficulty.PEACEFUL) {
+      if (p_241841_1_.getDifficulty() != Difficulty.PEACEFUL && net.minecraftforge.event.ForgeEventFactory.canLivingConvert(this, EntityType.WITCH, (timer) -> {})) {
          LOGGER.info("Villager {} was struck by lightning {}.", this, p_241841_2_);
          WitchEntity witchentity = EntityType.WITCH.create(p_241841_1_);
          witchentity.moveTo(this.getX(), this.getY(), this.getZ(), this.yRot, this.xRot);
@@ -699,7 +_,13 @@
          }
 
          witchentity.setPersistenceRequired();
-         p_241841_1_.addFreshEntityWithPassengers(witchentity);
+         net.minecraftforge.event.ForgeEventFactory.onLivingConvert(this, witchentity);
+         // CraftBukkit start
+         if (CraftEventFactory.callEntityTransformEvent(this, witchentity, EntityTransformEvent.TransformReason.LIGHTNING).isCancelled()) {
+            return;
+         }
+         this.level.addEntity(witchentity, CreatureSpawnEvent.SpawnReason.LIGHTNING);
+         // CraftBukkit end
          this.releaseAllPois();
          this.remove();
       } else {
@@ -717,6 +_,13 @@
             return;
          }
 
+         // CraftBukkit start
+         ItemStack remaining = new Inventory(inventory).addItem(itemstack);
+         if (CraftEventFactory.callEntityPickupItemEvent(this, p_175445_1_, remaining.getCount(), false).isCancelled()) {
+            return;
+         }
+         // CraftBukkit end
+
          this.onItemPickup(p_175445_1_);
          this.take(p_175445_1_, itemstack.getCount());
          ItemStack itemstack1 = inventory.addItem(itemstack);
@@ -820,7 +_,7 @@
             IronGolemEntity irongolementity = EntityType.IRON_GOLEM.create(p_213759_1_, (CompoundNBT)null, (ITextComponent)null, (PlayerEntity)null, blockpos1, SpawnReason.MOB_SUMMONED, false, false);
             if (irongolementity != null) {
                if (irongolementity.checkSpawnRules(p_213759_1_, SpawnReason.MOB_SUMMONED) && irongolementity.checkSpawnObstruction(p_213759_1_)) {
-                  p_213759_1_.addFreshEntityWithPassengers(irongolementity);
+                  this.level.addEntity(irongolementity, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.VILLAGE_DEFENSE); // CraftBukkit
                   return irongolementity;
                }
 
